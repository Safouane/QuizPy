{% extends "base.html" %}
{% load static %}

{% block title %}Take Quiz - QuizPy{% endblock %}

{% block extra_head %}
    {{ block.super }}
    {# Add Bootstrap Icons if not already in base.html block #}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
        /* Optional: Custom styling for landing page */
    </style>
{% endblock %}


{% block content %}
<div class="row justify-content-center mt-4">
    <div class="col-md-8 col-lg-6">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">Start Your Quiz</h4>
            </div>
            <div class="card-body">
                <p class="card-text text-muted mb-4">Please enter your details and the quiz key provided by your teacher.</p>

                {# Form Submission Feedback Placeholders #}
                <div id="errorMessage" class="alert alert-danger d-none" role="alert"></div>

                <form id="startQuizForm">
                    {# No CSRF needed here typically #}

                    {# Student Information #}
                    <h5>Your Information</h5>
                    <div class="row g-3 mb-3">
                        <div class="col-sm-6">
                            <label for="studentName" class="form-label">Full Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="studentName" required>
                        </div>
                        <div class="col-sm-6">
                            <label for="studentClass" class="form-label">Class / Group</label>
                            <input type="text" class="form-control" id="studentClass">
                        </div>
                        <div class="col-sm-6">
                            <label for="studentId" class="form-label">ID / Number</label>
                            <input type="text" class="form-control" id="studentId">
                        </div>
                    </div>

                    <hr>

                    {# Quiz Access #}
                    <h5>Quiz Access</h5>
                     <div class="mb-3">
                        <label for="quizKey" class="form-label">Quiz Key <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-key-fill"></i></span>
                            <input type="text" class="form-control" id="quizKey" placeholder="Enter quiz key" required aria-label="Quiz Key" autocapitalize="off" autocomplete="off">
                        </div>
                     </div>

                    <div class="d-grid mt-4">
                        <button type="submit" class="btn btn-primary btn-lg" id="startQuizBtn">
                            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true" id="startSpinner"></span>
                            Start Quiz
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}


{% block extra_scripts %}
{{ block.super }}
<script>
    // --- Constants ---
    const LOCAL_STORAGE_KEY_PREFIX = 'quizState_'; // Must match quiz_taking.html

    // --- DOM Elements ---
    const startQuizForm = document.getElementById('startQuizForm');
    const studentNameInput = document.getElementById('studentName');
    const studentClassInput = document.getElementById('studentClass');
    const studentIdInput = document.getElementById('studentId');
    const quizKeyInput = document.getElementById('quizKey');
    const errorMessageDiv = document.getElementById('errorMessage');
    const startQuizBtn = document.getElementById('startQuizBtn');
    const startSpinner = document.getElementById('startSpinner');

    // --- Helper Functions ---
    function setButtonState(isLoading) {
        startQuizBtn.disabled = isLoading;
        if (isLoading) {
            startSpinner.classList.remove('d-none');
        } else {
            startSpinner.classList.add('d-none');
        }
    }
    function showError(message) {
        errorMessageDiv.textContent = message;
        errorMessageDiv.classList.remove('d-none');
    }
    function clearMessages() {
        errorMessageDiv.classList.add('d-none');
        errorMessageDiv.textContent = '';
    }
    function escapeHTML(str) {
       if (str === null || str === undefined) return '';
       const div = document.createElement('div');
       div.appendChild(document.createTextNode(str));
       return div.innerHTML;
    }
    /**
     * Gets the localStorage key specific to a quiz attempt.
     * Note: Enhance with student identifier if needed for multi-student scenarios on same browser.
     */
    function getLocalStorageKeyForQuiz(quizId) {
        // Make sure quizId is a string before creating key
        return `${LOCAL_STORAGE_KEY_PREFIX}${String(quizId)}`;
    }


    // --- Form Submission Handler ---
    startQuizForm.addEventListener('submit', async function(event) {
        event.preventDefault();
        clearMessages();
        setButtonState(true); // Show spinner, disable button

        const studentInfo = {
            name: studentNameInput.value.trim(),
            class: studentClassInput.value.trim(),
            id: studentIdInput.value.trim()
        };
        const quizKey = quizKeyInput.value.trim();

        // Basic client-side validation
        if (!studentInfo.name || !quizKey) {
            showError('Please enter your Full Name and the Quiz Key.');
            setButtonState(false);
            return;
        }

        // --- Step 1: Validate Key via API-3 & Get Quiz ID / Full Data ---
        const accessApiUrl = "{% url 'quiz:quiz_access' %}"; // Use named URL for API-3
        const accessPayload = { quiz_key: quizKey };
        let quizIdFromKey = null;
        let validationError = null;
        let apiResponseData = null; // To store the successful API response (should contain full quiz structure)

        try {
            console.log("DEBUG: Validating key:", quizKey);
            const accessResponse = await fetch(accessApiUrl, {
                 method: 'POST',
                 headers: { 'Content-Type': 'application/json' },
                 body: JSON.stringify(accessPayload)
            });
            // Try to parse JSON regardless of status code
            try {
                apiResponseData = await accessResponse.json();
            } catch (e) {
                 console.error("Error parsing API response:", e);
                 // Throw error only if status indicates failure, otherwise maybe proceed if structure missing but 200 OK? Risky.
                 if (!accessResponse.ok) {
                    throw new Error(`Received invalid response from server (status: ${accessResponse.status})`);
                 } else {
                    // Received 200 OK but couldn't parse JSON? Unlikely from our API but handle defensively.
                    apiResponseData = null; // Treat as invalid data
                 }
            }

            if (accessResponse.ok && apiResponseData && apiResponseData.id) {
                 quizIdFromKey = apiResponseData.id; // Got the valid Quiz ID
                 console.log("DEBUG: Key valid, corresponds to Quiz ID:", quizIdFromKey);
                 // Keep apiResponseData as it contains the full quiz structure needed later
            } else {
                 validationError = apiResponseData?.error || `Invalid Quiz Key or Quiz is inactive (${accessResponse.status}).`;
                 console.log("DEBUG: Key validation failed via API:", validationError);
            }
        } catch(error) {
             console.error("Error during key validation fetch:", error);
             validationError = "An error occurred while validating the key. Check network connection.";
        }

        // If key validation failed OR we didn't get a valid ID/data, show error and stop
        if (validationError || !quizIdFromKey || !apiResponseData) {
             showError(validationError || "Failed to validate quiz key or retrieve quiz data.");
             setButtonState(false);
             return;
        }

        // --- Step 2: Key is valid, Check localStorage for Saved State ---
        const storageKey = getLocalStorageKeyForQuiz(quizIdFromKey);
        let savedState = null; // Holds parsed data from localStorage
        let storedStateValue = null;
        try {
             storedStateValue = localStorage.getItem(storageKey);
             if (storedStateValue) {
                  savedState = JSON.parse(storedStateValue);
                  console.log("DEBUG: Found saved state in localStorage:", savedState);
                  // Optional: Add validation of savedState structure here
             } else {
                  console.log("DEBUG: No saved state found for key:", storageKey);
             }
        } catch (e) {
             console.error("Error reading or parsing saved state from localStorage:", e);
             localStorage.removeItem(storageKey); // Clear potentially corrupt data
             savedState = null;
        }

        // --- Step 3: Prompt user if saved state exists ---
        let resumeQuiz = false;
    if (savedState) {
         console.log("DEBUG: Found saved state. Checking student info match.");
         // Compare saved student name with current input (case-insensitive)
         // Use name for comparison now, could enhance with ID later if IDs are reliably unique/entered
         const savedStudentName = savedState.studentInfo?.name?.trim().toLowerCase();
         const currentStudentName = studentInfo.name.toLowerCase(); // Already trimmed

         if (savedStudentName && savedStudentName === currentStudentName) {
              console.log("DEBUG: Student info matches. Prompting for resume.");
              resumeQuiz = confirm("Resume previous attempt for " + escapeHTML(studentInfo.name) + "?");
              if (!resumeQuiz) {
                   // Clear state ONLY if user explicitly declines resume for THEIR attempt
                   console.log("DEBUG: User declined resume. Clearing their saved state.");
                   localStorage.removeItem(storageKey);
                   savedState = null; // Ensure we treat as fresh start later
              }
              // If they confirm resume, leave savedState as is, resumeQuiz is true
         } else {
              console.log(`DEBUG: Saved state found, but student info does not match. Saved: "${savedStudentName}", Current: "${currentStudentName}". Ignoring saved state.`);
              // Don't prompt, proceed as fresh start. Do NOT clear the other student's state.
              savedState = null; // Treat as no valid saved state found for *this* specific user
              resumeQuiz = false;
         }
    } else {
         // No saved state found at all
         resumeQuiz = false;
    }
        

        // --- Step 4: Set up sessionStorage & Redirect ---
        try {
         // Always store current student info, key attempt, and validated ID
         sessionStorage.setItem('quizStudentInfo', JSON.stringify(studentInfo));
         sessionStorage.setItem('quizKeyAttempted', quizKey);
         sessionStorage.setItem('quizIdToTake', quizIdFromKey);

         // Always store the FRESH quiz structure from API-3
         if (!apiResponseData || !apiResponseData.id) {
              throw new Error("Missing valid quiz data received from API.");
         }
         sessionStorage.setItem(`quizData_${quizIdFromKey}`, JSON.stringify(apiResponseData));
         console.log("DEBUG: Stored FRESH quiz structure from API-3 into sessionStorage");


         if (resumeQuiz) { // Check the final decision after potential prompt
              // --- Resuming ---
              console.log("DEBUG: Proceeding with resume.");
              sessionStorage.setItem(`resumeState_${quizIdFromKey}`, 'true'); // Set flag
              // LocalStorage state remains untouched here, quiz_taking page will read it
              console.log("DEBUG: Resume flag set in sessionStorage.");

         } else {
              // --- Starting Fresh OR Chose NOT to Resume ---
              console.log("DEBUG: Proceeding with fresh start.");
              sessionStorage.removeItem(`resumeState_${quizIdFromKey}`); // Ensure no resume flag
              // Note: localStorage was already cleared above if user declined *their own* resume
         }

          // --- Redirect to Quiz Taking Page ---
         const redirectUrl = `/quiz/take/${quizIdFromKey}/`;
         console.log("DEBUG: Redirecting to quiz page:", redirectUrl);
         window.location.href = redirectUrl;

    } catch (error) {
         console.error("Error storing session data or redirecting:", error);
         showError(`Cannot proceed: ${error.message}. Browser session/local storage might be unavailable or failed.`);
         setButtonState(false); // Re-enable button on error before redirect
    }

    });

    /**
     * Basic HTML escaping function to prevent XSS from dynamic text insertion.
     * Consider a more robust library if handling complex user-generated HTML.
     * @param {string|null|undefined} str - The string to escape.
     * @returns {string} - The HTML-escaped string.
     */
     function escapeHTML(str) {
       if (str === null || str === undefined) return '';
       // Use textContent assignment on a temporary element for reliable escaping
       const div = document.createElement('div');
       div.textContent = str;
       return div.innerHTML;
    }

</script>
{% endblock %}